<!DOCTYPE html>

<html lang="fr" class="material-style layout-fixed">

<head>
    <title>Compte utilisateur niveau_2</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="" />
    <meta name="keywords" content="">
    <meta name="author" content="" />
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="images/sib_logo.PNG">

    <!-- Google fonts -->
    <link href="" rel="stylesheet">


    <!-- Icon fonts -->
    <link rel="stylesheet" href= "assets/assets_user/fonts/fontawesome.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/ionicons.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/linearicons.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/open-iconic.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/pe-icon-7-stroke.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/feather.css">
  
    <!-- Core stylesheets -->
    <link rel="stylesheet" href= "assets/assets_user/css/bootstrap-material.css">
    <link rel="stylesheet" href= "assets/assets_user/css/shreerang-material.css">
    <link rel="stylesheet" href= "assets/assets_user/css/uikit.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Libs -->
    <link rel="stylesheet" href= "assets/assets_user/libs/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" href= "assets/assets_user/libs/flot/flot.css">
    <link rel="stylesheet" href="css/design.css">

    <style>
        body {
            background: linear-gradient(135deg, #f4f4f4 0%, #f4f4f4 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            max-width: 800px;
            margin: 20px auto;
            border: 2px solid #ffffff;
        }

     
    </style>

</head>

<body>
    <!-- [ Preloader ] Start -->
    <div class="page-loader">
        <div class="bg-primary"></div>
    </div>
    <!-- [ Preloader ] End -->

    <!-- [ Layout wrapper ] Start -->
    <div class="layout-wrapper layout-2">
        <div class="layout-inner">
            <!-- [ Layout sidenav ] Start -->
            <div id="layout-sidenav" class="layout-sidenav sidenav sidenav-vertical bg-white logo-dark">
                <!-- Brand demo (see assets/css/demo/demo.css) -->
                <div class="app-brand demo">
                    <span class="app-brand-logo demo">
                      <img src="images/sib_logo.PNG" alt="Brand Logo" class="img-fluid">
                    </span>
                    <a href="acceuil.html" class="app-brand-text demo sidenav-text font-weight-normal ml-2">WORKFLOW - AWA</a>
                    <a href="javascript:" class="layout-sidenav-toggle sidenav-link text-large ml-auto">
                        <i class="ion ion-md-menu align-middle"></i>
                    </a>
                </div>
                <div class="sidenav-divider mt-0"></div>

                <!-- Links -->
                <ul class="sidenav-inner py-1">

                    <!-- Dashboards -->
                    <li class="sidenav-item active">
                        <a href="acceuil.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-home"></i>
                            <div>Accueil</div>
                            <div class="pl-1 ml-auto">
                                <div class="badge badge-danger"></div>
                            </div>
                        </a>
                    </li>

                    <!-- Layouts -->


                    <!-- Forms & Tables -->
                    <li class="sidenav-divider mb-1"></li>

                    <li class="sidenav-item">
                      <a href="javascript:" class="sidenav-link sidenav-toggle font-weight-semibold">
                          <i class=""></i>
                          <div>Menu</div>
                      </a>
                                            <ul class="sidenav-menu">
                        <li id="intro_dmd" class="sidenav-item">
                          <a href="introduire_demandes.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-clipboard"></i>
                            <div>Introduire demande</div>
                          </a>
                        </li>
                        <li id="consult_dmd" class="sidenav-item">
                          <a href="consulter_demandes.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-grid"></i>
                            <div>Consulter mes demandes</div>
                          </a>
                        </li>
                        <li id="valid_dmd" class="sidenav-item">
                            <a href="demandes_validation.html" class="sidenav-link">
                              <i class="sidenav-icon feather icon-lock"></i>
                              <div>Valider des demandes</div>
                            </a>
                        </li>
                        <li id="stats_dmd" class="sidenav-item">
                            <a href="statistiques.html" class="sidenav-link">
                              <i class="bi bi-bar-chart"></i>
                              <div>Statistiques</div>
                            </a>
                          </li>
                      </ul>
                    </li>

                    <!--  Icons -->


                    <!-- Pages -->
                    <li class="sidenav-divider mb-1"></li>

                    <li class="sidenav-item">
                        <a href="" class="sidenav-link">
                            <i class="sidenav-icon feather icon-lock"></i>
                            <div>Login</div>
                        </a>
                    </li>
                    <li class="sidenav-item">
                        <a href="" class="sidenav-link">
                            <i class="sidenav-icon feather icon-user"></i>
                            <div>Signup</div>
                        </a>
                    </li>
                    <li class="sidenav-item">
                        <a href="" class="sidenav-link">
                            <i class="sidenav-icon feather icon-anchor"></i>
                            <div>FAQ</div>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- [ Layout sidenav ] End -->


            <!-- [ Layout container ] Start -->
            <div class="layout-container">
                <!-- [ Layout navbar ( Header ) ] Start -->
                <nav class="layout-navbar navbar navbar-expand-lg align-items-lg-center bg-dark container-p-x" id="layout-navbar">

                    <div class="navbar-collapse collapse" id="layout-navbar-collapse">
                        <!-- Divider -->
                        <div class="navbar-nav align-items-lg-center ml-auto">

                            <!-- Divider -->
                            <div class="nav-item d-none d-lg-block text-big font-weight-light line-height-1 opacity-25 mr-3 ml-1">|</div>
                            <div class="demo-navbar-user nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                                    <span class="d-inline-flex flex-lg-row-reverse align-items-center align-middle">
                                        <img src="images/avatar.png" alt class="d-block ui-w-30 rounded-circle">
                                        <span id="user_id" class="px-1 mr-lg-2 ml-2 ml-lg-0"></span>
                                    </span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-user text-muted"></i> &nbsp; My profile</a>
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-mail text-muted"></i> &nbsp; Messages</a>
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-settings text-muted"></i> &nbsp; Account settings</a>
                                    <div class="dropdown-divider"></div>
                                    
                                      <a href="" class="dropdown-item">
                                        <i class="feather icon-power text-danger"></i> &nbsp;
                                        <input type="button" onclick="logout()" name="" value="Déconnexion">
                                      </a>
                                   

                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
                <!-- [ Layout navbar ( Header ) ] End -->

                <!-- [ Layout content ] Start -->
                <div class="layout-content">

                    <div class="container-fluid flex-grow-1 container-p-y">
                        <h4 class="font-weight-bold py-3 mb-0">MES DEMANDES</h4>

                        <div class="row">

                            <!-- 3rd row Start -->

                            <div style="height: 310px" id="tasks-inner"></div>

                            <div class="col-xl-12">
                                <div class="card mb-4">
                                    <div class="card-header with-elements pb-0">
                                        <h6 class="card-header-title mb-0"></h6>
                                        <div class="card-header-elements ml-auto p-0">
                                            <ul class="nav nav-tabs">
                                                <li class="nav-item">
                                                    <a class="nav-link active" data-toggle="tab" href="#demande-intro">Demandes Introduites</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#demande-val">Demandes fin de processus</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="nav-tabs-top">
                                        <div class="tab-content">

                                            <div class="tab-pane fade show active" id="demande-intro">
                                                <div style="height: 330px" id="tab-table-1">
                                                    <table class="table table-hover card-table">
                                                        <thead>
                                                            <tr>
                                                                <th style="font-weight: bold;">Type de demande</th>
                                                                <th style="font-weight: bold;">Banque</th>
                                                                <th style="font-weight: bold;">Entité</th>
                                                                 <th style="font-weight: bold;">Contrepartie</th>
                                                                <th style="font-weight: bold;">Montant (Xof)</th>
                                                                <th style="font-weight: bold;"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="dmd_intro">


                                                        </tbody>
                                                    </table>
                                                </div>
                                                <a href="javascript:" class="card-footer d-block text-center text-dark small font-weight-semibold"></a>
                                            </div>
                                            <div class="tab-pane fade" id="demande-val">
                                                <div style="height: 330px" id="tab-table-2">
                                                    <table class="table table-hover card-table">
                                                        <thead>
                                                            <tr>
                                                                
                                                                <th style="font-weight: bold;">Type de demande</th>
                                                                <th style="font-weight: bold;">Filiale</th>
                                                                <th style="font-weight: bold;">Contrepartie</th>
                                                                <th style="font-weight: bold;">Entité</th>
                                                                <th style="font-weight: bold;">Montant (Xof)</th>
                                                                
                                                                
                                                            </tr>
                                                        </thead>
                                                        <tbody id="dmd_valid">
                                                            
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <a href="javascript:" class="card-footer d-block text-center text-dark small font-weight-semibold"></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 3rd row Start -->
                        </div>

					</div>
                    
                </div>


                <!-- [ content ] End -->

                <!-- [ Layout footer ] Start -->
                <nav class="layout-footer footer bg-white">
                    <div class="container-fluid d-flex flex-wrap justify-content-between text-center container-p-x pb-3">
                        <div class="pt-3">
                            <span class="footer-text font-weight-semibold">&copy; <a href="" class="footer-link" target="_blank">Attijariwestafrica</a></span>
                        </div>
                        <div>
                            <a href="javascript:" class="footer-link pt-3">About Us</a>
                            <a href="javascript:" class="footer-link pt-3 ml-4">Help</a>
                            <a href="javascript:" class="footer-link pt-3 ml-4">Contact</a>
                            <a href="javascript:" class="footer-link pt-3 ml-4">Terms &amp; Conditions</a>
                        </div>
                    </div>
                </nav>
                <!-- [ Layout footer ] End -->

                </div>
                <!-- [ Layout content ] Start -->
            </div>
            <!-- [ Layout container ] End -->
        </div>
        <!-- Overlay -->
        <div class="layout-overlay layout-sidenav-toggle"></div>
    </div>
    <!-- [ Layout wrapper] End -->

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Voulez-vous vraiment cloturer cette demande  ?</h5>
                </div>
                <div class="modal-body">
                    <label for="comm"><strong>Commentaire</strong></label>
                    <textarea class='form-control' id='comm' name='comm' placeholder="Laisser un message"></textarea>
                </div>
                <input type="hidden" id='id_dmd' name="id_dmd" value=''>    
                <div class="clearfix"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelSubmission()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSubmission()">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de confirmation pour le DG -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Cloturer demande</h5>
                </div>
                <div class="modal-body">
                    Demande  cloturée !
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="cancelSuccess()">OK</button>
                </div>
            </div>
        </div>
    </div>

</body>

    <!-- Core scripts -->
    <script src= "assets/assets_user/js/pace.js"></script>
    <script src= "assets/assets_user/js/jquery-3.3.1.min.js"></script>
    <script src= "assets/assets_user/libs/popper/popper.js"></script>
    <script src= "assets/assets_user/js/bootstrap.js"></script>
    <script src= "assets/assets_user/js/sidenav.js"></script>
    <script src= "assets/assets_user/js/layout-helpers.js"></script>
    <script src= "assets/assets_user/js/material-ripple.js"></script>

    <!-- Libs -->
    <script src= "assets/assets_user/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src= "assets/assets_user/libs/eve/eve.js"></script>
    <!-- <script src= "assets/assets_user/libs/flot/flot.js"></script> -->
    <script src= "assets/assets_user/libs/flot/curvedLines.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/core.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/charts.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/animated.js"></script>

    <!-- Demo -->
    <script src= "assets/assets_user/js/demo.js"></script><script src="assets/assets_user/js/analytics.js"></script>
    <script src= "assets/assets_user/js/pages/dashboards_index.js"></script>
    <script src="js/design.js"></script>
    
    <script>

        //const API_URL = "http://127.0.0.1:8000/api";
        const API_URL = "https://workflow-awa.onrender.com/api";

        async function logout() {
                
            localStorage.removeItem("token");
            //window.location.href = 'index.html';
        }

        async function infos_user() {
            
            const token = localStorage.getItem("token");

            const response = await fetch(`${API_URL}/users-joined/`,{
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
            });

            // Vérifier si la requête a réussi
            if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
            }
                
            const donnees = await response.json();
            
            const infos_user = donnees.results;

            document.getElementById("user_id").innerText = infos_user[0].prenom + " " + infos_user[0].nom;
            
            
            if (infos_user[0].niveau_hab==="Niveau 1") {
                
                document.getElementById('intro_dmd').style.display = 'none';
                document.getElementById('consult_dmd').style.display = 'none';
                document.getElementById('valid_dmd').style.display = 'none';

            } else if (infos_user[0].niveau_hab==="Niveau 2") {
                document.getElementById('valid_dmd').style.display = 'none';
                
            } else if (infos_user[0].niveau_hab==="Niveau 3") {
                document.getElementById('intro_dmd').style.display = 'none';
                document.getElementById('consult_dmd').style.display = 'none';
                
            } 
            
        }

        async function isConnected() {

            const token = localStorage.getItem("token");

            if (token) {
                console.log("Token présent :", token);
            } else {
                console.log("Aucun token trouvé");
                window.location.href = 'index.html';
            }
            
        }



        function formatNumber(number) {
            return Number(number).toLocaleString('fr-FR', { minimumFractionDigits: 0 });
        }

        //fonction pour charger les demandes ayant été validées au moins une fois par l'utilisateur
        function generateValidDemandesValiderRows(dmd_valid) {
            const tableBody = document.getElementById("dmd_valid");
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }

            if (dmd_valid.length > 0) {
                dmd_valid.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                       <td class="align-middle">
                            <label>${escapeHtml(row.type_demande)}<br></label>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="align-self-center ml-3">
                                    ${escapeHtml(row.banque)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(row.nom_client)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(row.categorie_demande)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(formatNumber(row.montant))}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    <button type="button" onclick="window.location.href='detail_consulter_demande.html?id_dmd=${row.id_demande}'" class="btn btn-dark">Détails</button>
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    <button type="button" onclick="showConfirmation(${row.id_demande})" class="btn btn-outline-primary">Cloturer</button>
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        //fonction pour charger les demandes ayant été introduites simplement et devant être validées
        function generateTableDemandeRows(dmd) {
            
            const tableBody = document.getElementById('dmd_intro');
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }
            
            if (dmd.length > 0) {
                
                dmd.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="align-middle">
                            <label>${escapeHtml(row.type_demande)}<br></label>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="align-self-center ml-3">
                                    ${escapeHtml(row.banque)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(row.nom_client)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(row.categorie_demande)}
                                </div>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    ${escapeHtml(formatNumber(row.montant))}
                                </div>
                            </div>
                        </td>
                        
                        <td class="align-middle">
                            <div>
                                <div class="d-inline-block align-middle">
                                    <button type="button" onclick="window.location.href='valider_demande.html?id_dmd=${row.id_demande}'" class="btn btn-glow-info btn-info">Evaluer</button>
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }


        async function load_data_demandes() {

            // CETTE FONCTION CONSISTE A CHARGER LES DONNEES DU FORMULAIRE D'insertion des demandes 
            const token = localStorage.getItem("token");

            const response = await fetch(`${API_URL}/demandes_a_valider/`,{
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });
            

            // Vérifier si la requête a réussi
            if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
            }
                
            const donnees = await response.json();
            
            const demandes = donnees.results;
            

            try {
                
                generateTableDemandeRows(demandes);               
                
            } catch(error) {
                console.error('Erreur lors du chargement des données:', error);
                alert('Impossible de charger les données du tableau. Veuillez réessayer.');
            }
        }

        async function load_data_demandes_validation() {

            // CETTE FONCTION CONSISTE A CHARGER DEMANDES ARRIVEES AU BOUT DU PROCESSUS
            
            const token = localStorage.getItem("token");

            const response = await fetch(`${API_URL}/demandes_a_cloturer/`,{
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });


            // Vérifier si la requête a réussi
            if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
            }
            
            const donnees = await response.json();
            
            const demandes = donnees.results;
            
            try {
                
                generateValidDemandesValiderRows(demandes);               
                
            } catch(error) {
                console.error('Erreur lors du chargement des données:', error);
                alert('Impossible de charger les données du tableau. Veuillez réessayer.');
            }
        }

        function cancelSubmission() {
            //const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            //modal.hide();
            $('#confirmationModal').modal('hide');
        }

        function showConfirmation($id_demande) {

            //event.preventDefault();  
            //alert($id_demande);

            document.getElementById('id_dmd').value = $id_demande;

            $('#confirmationModal').modal('show');

            //const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                
            //modal.show();
        }

        async function confirmSubmission() {
        
            $('#confirmationModal').modal('hide');

         
            const demande_id = document.getElementById("id_dmd").value
            

            const formData = new FormData();
            formData.append("commentaire", document.getElementById("comm").value);
            formData.append("id_decision", 1);
            
            console.log("FormData avant fichier:", {
                    commentaire_intro: formData.get("commentaire"),
            });


            try {
                
                const token = localStorage.getItem("token");

                const response = await fetch(`${API_URL}/cloturer_demande/${demande_id}`, {
                    method: 'POST',
                    body: formData,
                    "Authorization": "Bearer " + token
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erreur HTTP: ${response.status}, Détails: ${JSON.stringify(formData)}`);
                }

                const result = await response.json();
                // Afficher une modale de succès après la soumission
                $('#successModal').modal('show');


            } catch (error) {
                console.error('Erreur lors de la soumission :', error);
                alert('Erreur lors de la soumission du formulaire !!!');
            }

        
        }

        
        function cancelSuccess() {
            $('#successModal').modal('hide');
            window.location.reload();
        }

        window.addEventListener('load', () => isConnected());
        window.addEventListener('load', () => infos_user());
        window.addEventListener('load', () => infos_user());
        window.addEventListener('load', () => load_data_demandes());
        window.addEventListener('load', () => load_data_demandes_validation());

      
    </script>
    


</html>
