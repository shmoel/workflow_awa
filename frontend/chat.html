<!DOCTYPE html>

<html lang="fr" class="material-style layout-fixed">

<head>
    <title>Accueil</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="" />
    <meta name="keywords" content="">
    <meta name="author" content="" />
    <link rel="icon" type="image/x-icon" href="">

    <!-- Google fonts -->
    <link href="" rel="stylesheet">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="images/sib_logo.PNG">

    <!-- Icon fonts -->
    <link rel="stylesheet" href= "assets/assets_user/fonts/fontawesome.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/ionicons.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/linearicons.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/open-iconic.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/pe-icon-7-stroke.css">
    <link rel="stylesheet" href= "assets/assets_user/fonts/feather.css">
  
    <!-- Core stylesheets -->
    <link rel="stylesheet" href= "assets/assets_user/css/bootstrap-material.css">
    <link rel="stylesheet" href= "assets/assets_user/css/shreerang-material.css">
    <link rel="stylesheet" href= "assets/assets_user/css/uikit.css">
  
    <!-- Libs -->
    <link rel="stylesheet" href= "assets/assets_user/libs/perfect-scrollbar/perfect-scrollbar.css">
     <!--<link rel="stylesheet" href= "assets/assets_user/libs/flot/flot.css"> -->
    <link rel="stylesheet" href="css/design.css">

     <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #475569;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* En-t√™te principal avec couleur orange */
        .chat-header {
            background-color: #ea580c;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .clear-btn {
            background-color: #f97316;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .clear-btn:hover {
            background-color: #c2410c;
        }

        /* Zone des messages avec fond blanc */
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f1f5f9;
        }

  
        /* Structure des messages - alignement par d√©faut √† gauche pour les autres utilisateurs */
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s ease;
            /* Par d√©faut, les messages sont align√©s √† gauche (autres utilisateurs) */
        }

        /* Messages de l'utilisateur connect√© - align√©s √† droite */
        .message .sender {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #333;
        }


        .user-message {
            background: #ea580c;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: #ea580c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .bot-message {
            background: #fff;
            color: #333;
            margin-right: auto;
            border: 1px solid #ddd;
            border-bottom-left-radius: 0;
        }




        /* Zone de saisie avec fond blanc */
        .chat-input {
            background-color: white;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .user-select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: white;
            color: #475569;
            font-size: 0.875rem;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 1.5rem;
            outline: none;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #ea580c;
        }

        /* Bouton d'envoi orange */
        .send-btn {
            background-color: #ea580c;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: #c2410c;
        }

        .send-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            color: #64748b;
            font-style: italic;
            margin-top: 2rem;
        }

        /* En-t√™te des informations de demande avec fond blanc */
        .request-header {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-value {
            font-size: 0.875rem;
            color: #1e293b;
            font-weight: 600;
        }

        .request-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Section d'authentification avec fond blanc */
        .auth-section {
            background-color: white;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #ea580c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }


    </style>
    
</head>

<body>
    <!-- [ Preloader ] Start -->
    <div class="page-loader">
        <div class="bg-primary"></div>
    </div>
    <!-- [ Preloader ] End -->

    <!-- [ Layout wrapper ] Start -->
    <div class="layout-wrapper layout-2">
        <div class="layout-inner">
            <!-- [ Layout sidenav ] Start -->
            <div id="layout-sidenav" class="layout-sidenav sidenav sidenav-vertical bg-white logo-dark">
                <!-- Brand demo (see assets/css/demo/demo.css) -->
                <div class="app-brand demo">
                    <span class="app-brand-logo demo">
                      <img src="images/sib_logo.PNG" alt="Brand Logo" class="img-fluid">
                    </span>
                    <a href="acceuil.html" class="app-brand-text demo sidenav-text font-weight-normal ml-2">WORKFLOW - AWA</a>
                    <a href="javascript:" class="layout-sidenav-toggle sidenav-link text-large ml-auto">
                        <i class="ion ion-md-menu align-middle"></i>
                    </a>
                </div>
                <div class="sidenav-divider mt-0"></div>

                <!-- Links -->
                <ul class="sidenav-inner py-1">

                    <!-- Dashboards -->
                    <li class="sidenav-item active">
                        <a href="acceuil.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-home"></i>
                            <div>Acceuil</div>
                            <div class="pl-1 ml-auto">
                                <div class="badge badge-danger"></div>
                            </div>
                        </a>
                    </li>

                    <!-- Layouts -->


                                      <!-- Forms & Tables -->
                    <li class="sidenav-divider mb-1"></li>

                    <li class="sidenav-item">
                      <a href="javascript:" class="sidenav-link sidenav-toggle font-weight-semibold">
                          <i class=""></i>
                          <div>Actions</div>
                      </a>
                      <ul class="sidenav-menu">
                        <li id="intro_dmd" class="sidenav-item">
                          <a href="introduire_demandes.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-clipboard"></i>
                            <div>Introduire demande</div>
                          </a>
                        </li>
                        <li id="consult_dmd" class="sidenav-item">
                          <a href="consulter_demandes.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-grid"></i>
                            <div>Consulter mes demandes</div>
                          </a>
                        </li>
                        <li id="valid_dmd" class="sidenav-item">
                            <a href="demandes_validation.html" class="sidenav-link">
                              <i class="sidenav-icon feather icon-lock"></i>
                              <div>Valider des demandes</div>
                            </a>
                        </li>
                        <li id="valid_dmd_ggrg" class="sidenav-item">
                            <a href="ggrg_demandes_validation.html" class="sidenav-link">
                              <i class="sidenav-icon feather icon-lock"></i>
                              <div>Valider des demandes</div>
                            </a>
                        </li>
                        <li id="stats_dmd" class="sidenav-item">
                            <a href="statistiques.html" class="sidenav-link">
                              <i class="sidenav-icon feather icon-lock"></i>
                              <div>Statistiques</div>
                            </a>
                          </li>
                      </ul>
                    </li>

                    <!--  Icons -->


                    <!-- Pages -->
                    <li class="sidenav-divider mb-1"></li>

                    <li class="sidenav-item">
                        <a href="pages_authentication_login-v1.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-lock"></i>
                            <div>Login</div>
                        </a>
                    </li>
                    <li class="sidenav-item">
                        <a href="pages_authentication_register-v1.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-user"></i>
                            <div>Signup</div>
                        </a>
                    </li>
                    <li class="sidenav-item">
                        <a href="pages_faq.html" class="sidenav-link">
                            <i class="sidenav-icon feather icon-anchor"></i>
                            <div>FAQ</div>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- [ Layout sidenav ] End -->


            <!-- [ Layout container ] Start -->
            <div class="layout-container">
                <!-- [ Layout navbar ( Header ) ] Start -->
                <nav class="layout-navbar navbar navbar-expand-lg align-items-lg-center bg-dark container-p-x" id="layout-navbar">

                    <div class="navbar-collapse collapse" id="layout-navbar-collapse">
                        <!-- Divider -->
                        <div class="navbar-nav align-items-lg-center ml-auto">

                            <!-- Divider -->
                            <div class="nav-item d-none d-lg-block text-big font-weight-light line-height-1 opacity-25 mr-3 ml-1">|</div>
                            <div class="demo-navbar-user nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                                    <span class="d-inline-flex flex-lg-row-reverse align-items-center align-middle">
                                        <img src="images/avatar.png" alt class="d-block ui-w-30 rounded-circle">
                                        <span id="user_id" class="px-1 mr-lg-2 ml-2 ml-lg-0"></span>
                                    </span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-user text-muted"></i> &nbsp; My profile</a>
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-mail text-muted"></i> &nbsp; Messages</a>
                                    <a href="javascript:" class="dropdown-item">
                                        <i class="feather icon-settings text-muted"></i> &nbsp; Account settings</a>
                                    <div class="dropdown-divider"></div>
                                    
                                      <a href="" class="dropdown-item">
                                        <i class="feather icon-power text-danger"></i> &nbsp;
                                        <input type="button" onclick="logout()" name="" value="D√©connexion">
                                      </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
                <!-- [ Layout navbar ( Header ) ] End -->

                <!-- [ Layout content ] Start -->
                <div class="layout-content">

                    <!-- [ content ] Start -->
                        <div class="row">

                        </div>
                        <div class="row">

                        </div>
                        <div class="row">
                            <!-- 3rd row Start -->
                            <div class="col-xl-2"></div>
                            <div class="col-xl-8">
                                
                                    <!-- En-t√™te principal orange -->
                                <div class="chat-container">
                                   <!-- En-t√™te principal orange -->
                                    <div class="chat-header">
                                        <h1>üè¶ Chat Demandes Bancaires <span class="info-value" id="requestNumber"></span></h1>
                                        
                                    </div>

                                    <!-- Section d'authentification - utilisateur connect√© -->
                                  

                                    <!-- En-t√™te des informations de la demande bancaire -->
                                    <div class="request-header">
                                        <div class="request-info">
                                            <div class="info-item">
                                                <span class="info-label">Banque</span>
                                                <span class="info-value" id="banque">DEM-2024-001234</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Client</span>
                                                <span class="info-value" id="clientName">Marie Martin</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Type de demande</span>
                                                <span class="info-value" id="requestType">Pr√™t Immobilier</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Montant</span>
                                                <span class="info-value" id="requestAmount">250 000 ‚Ç¨</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Statut</span>
                                                <span class="request-status status-processing" id="requestStatus">En cours</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Date d'introduction</span>
                                                <span class="info-value" id="requestDate">15/12/2024</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Zone des messages -->
                                    <div class="chat-messages" id="chat-messages">
                                        <!-- Messages seront ajout√©s ici -->
                                    </div>

                                    <!-- Zone de saisie -->
                                    <div class="chat-input">
                                        <input 
                                            type="text" 
                                            class="message-input" 
                                            id="user-input" 
                                            placeholder="R√©pondre au client concernant sa demande..."
                                            onkeypress=""
                                        >
                                        <button class="send-btn" id="send-button">Envoyer</button>
                                    </div>
                                </div>           
                                        
                            </div>
                            <div class="col-xl-2"></div>
                          
                        </div>
                        <div class="row"></div>
					
                    <!-- [ content ] End -->

                    <!-- [ Layout footer ] Start -->
                    <nav class="layout-footer footer bg-white">
                        <div class="container-fluid d-flex flex-wrap justify-content-between text-center container-p-x pb-3">
                            <div class="pt-3">
                                <span class="footer-text font-weight-semibold">&copy; <a href="" class="footer-link" target="_blank">Attijariwestafrica</a></span>
                            </div>
                            <div>
                                <a href="javascript:" class="footer-link pt-3">About Us</a>
                                <a href="javascript:" class="footer-link pt-3 ml-4">Help</a>
                                <a href="javascript:" class="footer-link pt-3 ml-4">Contact</a>
                                <a href="javascript:" class="footer-link pt-3 ml-4">Terms &amp; Conditions</a>
                            </div>
                        </div>
                    </nav>
                    <!-- [ Layout footer ] End -->
                </div>
                <!-- [ Layout content ] Start -->
            </div>
            <!-- [ Layout container ] End -->
        </div>
        <!-- Overlay -->
        <div class="layout-overlay layout-sidenav-toggle"></div>
    </div>
    <!-- [ Layout wrapper] End -->

    
</body>

<!-- Core scripts -->
    <script src= "assets/assets_user/js/pace.js"></script>
    <script src= "assets/assets_user/js/jquery-3.3.1.min.js"></script>
    <script src= "assets/assets_user/libs/popper/popper.js"></script>
    <script src= "assets/assets_user/js/bootstrap.js"></script>
    <script src= "assets/assets_user/js/sidenav.js"></script>
    <script src= "assets/assets_user/js/layout-helpers.js"></script>
    <script src= "assets/assets_user/js/material-ripple.js"></script>

    <!-- Libs -->
    <script src= "assets/assets_user/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src= "assets/assets_user/libs/eve/eve.js"></script>
    <!-- <script src= "assets/assets_user/libs/flot/flot.js"></script> -->
    <script src= "assets/assets_user/libs/flot/curvedLines.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/core.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/charts.js"></script>
    <script src= "assets/assets_user/libs/chart-am4/animated.js"></script>

    <!-- Demo -->
    <script src= "assets/assets_user/js/demo.js"></script><script src="assets/assets_user/js/analytics.js"></script>
    <script src= "assets/assets_user/js/pages/dashboards_index.js"></script>
    <script src="js/design.js"></script>
   
 
    <script>

        //const API_URL = "http://127.0.0.1:8000/api";
        const API_URL = "https://workflow-awa.onrender.com/api";
    
        
        async function logout() {
        
            localStorage.removeItem("token");
            //window.location.href = 'index.html';
        }

        async function infos_user() {

            const token = localStorage.getItem("token");
            
            const response = await fetch(`${API_URL}/users-joined/`, {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
            });
            
            // V√©rifier si la requ√™te a r√©ussi
            if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
            }
                
            const donnees = await response.json();
            
            const infos_user = donnees.results;

            document.getElementById("user_id").innerText = infos_user[0].prenom + " " + infos_user[0].nom;
            
            
            if (infos_user[0].niveau_hab==="Niveau 1") {
                
                document.getElementById('intro_dmd').style.display = 'none';
                document.getElementById('consult_dmd').style.display = 'none';
                document.getElementById('valid_dmd').style.display = 'none';
                document.getElementById('valid_dmd_ggrg').style.display = 'none';

            } else if (infos_user[0].niveau_hab==="Niveau 2") {
                document.getElementById('valid_dmd').style.display = 'none';
                document.getElementById('valid_dmd_ggrg').style.display = 'none';
                
            } else if (infos_user[0].niveau_hab==="Niveau 3") {

                if(infos_user[0].banque==="AIG" && (infos_user[0].entite==="GGR")){
                    document.getElementById('intro_dmd').style.display = 'none';
                    document.getElementById('consult_dmd').style.display = 'none';
                    document.getElementById('valid_dmd').style.display = 'none';
                }else{
                    document.getElementById('intro_dmd').style.display = 'none';
                    document.getElementById('consult_dmd').style.display = 'none';
                    document.getElementById('valid_dmd_ggrg').style.display = 'none';
                }
                
                
                
            } 

            
        }

        /**
         * V√©rifie si l'utilisateur est connect√© (pr√©sence du token).
         * Redirige vers la page d'accueil si non connect√©.
         */
        async function isConnected() {

            const token = localStorage.getItem("token");

            if (token) {
                console.log("Token pr√©sent :", token);
            } else {
                console.log("Aucun token trouv√©");
                window.location.href = 'index.html';
            }
            
        }

        /**
         * R√©cup√®re les informations de l'utilisateur connect√© et adapte l'affichage du menu selon son niveau d'habilitation.
         */
        async function infos_user() {
        
            const token = localStorage.getItem("token");

            const response = await fetch(`${API_URL}/users-joined/`,{
                method: "GET",
                headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
                },
            });
            
            // V√©rifier si la requ√™te a r√©ussi
            if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
            }
                
            const donnees = await response.json();
            
            const infos_user = donnees.results;


            document.getElementById("user_id").innerText = infos_user[0].prenom + " " + infos_user[0].nom;
            
            
            if (infos_user[0].niveau_hab==="Niveau 1") {
                
                document.getElementById('intro_dmd').style.display = 'none';
                document.getElementById('consult_dmd').style.display = 'none';
                document.getElementById('valid_dmd').style.display = 'none';

            } else if (infos_user[0].niveau_hab==="Niveau 2") {
                document.getElementById('valid_dmd').style.display = 'none';
                
            } else if (infos_user[0].niveau_hab==="Niveau 3") {
                document.getElementById('intro_dmd').style.display = 'none';
                document.getElementById('consult_dmd').style.display = 'none';
                
            } 
            
        }

 

        /**
         * Enregistre un commentaire pour la demande en cours via l'API.
         * Utilise l'ID utilisateur et l'ID de la demande.
         */
        async function commenter(commentaire) {
            
            //alert("comment ca se passe");
            
            const params = new URLSearchParams(window.location.search);

            const id_demande = params.get("id_dmd");

            
            const token = localStorage.getItem("token");

            // R√©cup√©rer l'user_id
            const res = await fetch(`${API_URL}/users-joined/`,{
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    }
            });
            
            if (!res.ok) {
                throw new Error(`Erreur lors de la r√©cup√©ration de l'utilisateur : ${res.status}`);
            }
            
            const donnees = await res.json();
            if (!donnees.results || !donnees.results[0] || !donnees.results[0].user_id) {
                throw new Error("Utilisateur non trouv√©");
            }
            
            const id_user = donnees.results[0].user_id;
            
            const now = new Date();            
            // Cr√©er FormData pour les champs et le fichier
            const formData = new FormData();
            formData.append("id_user", id_user);
            formData.append("commentaire", commentaire);
            formData.append("demande_id", id_demande);
           
            
            const response = await fetch(`${API_URL}/commenter`, {
                method: "POST",
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                
            } else {
                alert(data.detail || "Erreur lors de l'ecriture du commentaire");
            }   
            
        }
        

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const userName = "Vous";
        const botName = "BanqueBot";

        let currentUser = null;
        let isSending = false;

        function getFormattedTimestamp() {
            const now = new Date();
            return now.toLocaleString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        /**
         * Affiche un indicateur de chargement sur le bouton d'envoi.
         * D√©sactive le bouton pendant l'envoi.
         */
        function showLoading(isLoading) {
            sendButton.disabled = isLoading;
            sendButton.textContent = isLoading ? 'Envoi...' : 'Envoyer';
        }

        /**
         * Affiche une notification (erreur ou succ√®s) en bas √† droite de la page.
         */
        function showNotification(message, type = 'error') {
            let notif = document.createElement('div');
            notif.textContent = message;
            notif.style.position = 'fixed';
            notif.style.bottom = '20px';
            notif.style.right = '20px';
            notif.style.background = type === 'error' ? '#ef4444' : '#22c55e';
            notif.style.color = 'white';
            notif.style.padding = '10px 20px';
            notif.style.borderRadius = '8px';
            notif.style.zIndex = '9999';
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        /**
         * R√©cup√®re et m√©morise les infos de l'utilisateur courant (API).
         * Utilis√© pour √©viter les appels multiples √† l'API.
         */
        async function getCurrentUser() {
            if (currentUser) return currentUser;
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/users-joined/`, {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + token,
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) throw new Error('Erreur utilisateur');
                const data = await response.json();
                currentUser = data.results[0];
                return currentUser;
            } catch (e) {
                showNotification('Impossible de r√©cup√©rer l‚Äôutilisateur', 'error');
                throw e;
            }
        }

        /**
         * Ajoute un message dans la zone de chat, avec avatar, nom, contenu et timestamp.
         * G√®re l'alignement selon l'exp√©diteur (utilisateur ou bot/autre).
         */
        function addMessage(text, isUser, other_user = '', date_message='', heure_message='') {
            const message = document.createElement('div');
            message.classList.add('message');
            message.classList.add(isUser ? 'user-message' : 'bot-message');

            // Avatar
            const avatar = document.createElement('span');
            avatar.classList.add('message-avatar');
            avatar.textContent = isUser ? userName[0] : (other_user ? other_user[0] : botName[0]);
            message.appendChild(avatar);

            // Sender
            const sender = document.createElement('div');
            sender.classList.add('sender');
            sender.textContent = isUser ? userName : other_user || botName;
            message.appendChild(sender);
            
            // Content
            const content = document.createElement('div');
            content.textContent = text;
            message.appendChild(content);

            // Timestamp
            const timestamp = document.createElement('div');
            timestamp.classList.add('timestamp');
            if (date_message && heure_message) {
                timestamp.textContent = `${date_message} ${heure_message}`;
            } else {
                timestamp.textContent = getFormattedTimestamp();
            }
            message.appendChild(timestamp);

            chatMessages.appendChild(message);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Simule la r√©ponse du bot selon le contenu du message utilisateur.
         * Peut √™tre enrichi pour des r√©ponses plus intelligentes.
         */
        async function getBotResponse(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1000));

            if (userMessage.toLowerCase().includes('solde')) {
                return 'Votre solde actuel est de 1 500 ‚Ç¨.';
            } else if (userMessage.toLowerCase().includes('virement')) {
                return 'Pour effectuer un virement, veuillez fournir l\'IBAN du destinataire et le montant.';
            } else if (userMessage.toLowerCase().includes('pr√™t')) {
                return 'Nous offrons des pr√™ts √† des taux comp√©titifs. Contactez-nous pour plus de d√©tails.';
            } else {
                return 'D√©sol√©, je ne comprends pas votre question. Pouvez-vous reformuler ?';
            }
        }

        /**
         * G√®re l'envoi d'un message utilisateur : enregistrement, affichage, r√©ponse bot.
         * D√©sactive le bouton pendant l'envoi et g√®re les erreurs.
         */
        sendButton.addEventListener('click', async () => {
            const userMessage = userInput.value.trim();
            if (userMessage === '' || isSending) return;
            showLoading(true);
            isSending = true;
            try {
                await commenter(userMessage);
                addMessage(userMessage, true);
                userInput.value = '';
                const botResponse = await getBotResponse(userMessage);
                addMessage(botResponse, false, botName);
            } catch (e) {
                // Erreur d√©j√† g√©r√©e
            } finally {
                showLoading(false);
                isSending = false;
            }
        });

        /**
         * Permet d'envoyer le message avec Enter ou Ctrl+Enter.
         */
        userInput.addEventListener('keydown', async (e) => {
            if ((e.key === 'Enter' && !e.shiftKey) || (e.key === 'Enter' && e.ctrlKey)) {
                sendButton.click();
                e.preventDefault();
            }
        });

        /**
         * Au chargement de la page : v√©rifie la connexion, affiche l'utilisateur, charge les messages de la demande.
         */
        window.addEventListener('load', () => isConnected());
        window.addEventListener('load', () => infos_user());
        window.addEventListener('load', async () => {
            try {
                const params = new URLSearchParams(window.location.search);
                const id_demande = params.get('id_dmd');
                const token = localStorage.getItem('token');
                const user = await getCurrentUser();
                const id_user = user.user_id;
                const response = await fetch(`${API_URL}/messages_chat/${id_demande}`, {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + token,
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) throw new Error('Erreur chargement messages');
                const comms = await response.json();
                console.log('R√©ponse JSON messages_chat:', comms); // <-- LOG AJOUT√â
                const liste_comms = comms.results;
                console.log('Ordre des messages (id, date, heure):', liste_comms.map(m => ({id: m.id, date: m.date_creation, heure: m.heure_creation})));
                chatMessages.innerHTML = '';
                if (liste_comms.length === 0) {
                    const empty = document.createElement('div');
                    empty.classList.add('empty-state');
                    empty.textContent = '';
                    chatMessages.appendChild(empty);
                } else {
                    // Tri explicite des messages du plus ancien au plus r√©cent
                    liste_comms.sort((a, b) => {
                        const dateA = a.date_creation + ' ' + a.heure_creation;
                        const dateB = b.date_creation + ' ' + b.heure_creation;
                        return dateA.localeCompare(dateB);
                    });
                    liste_comms.forEach(comm => {
                        if (comm.id_user == id_user) {
                            addMessage(comm.commentaire, true, '', comm.date_creation, comm.heure_creation);
                        } else {
                            addMessage(comm.commentaire, false, comm.username, comm.date_creation, comm.heure_creation);
                        }
                    });
                }
            } catch (e) {
                showNotification(e.message, 'error');
            }
        });


        /**
         * R√©cup√®re les infos de la demande et les affiche dans l'en-t√™te du chat
         */
        async function remplirEnteteDemande() {
            const params = new URLSearchParams(window.location.search);
            const id_demande = params.get('id_dmd');
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_URL}/demandes/${id_demande}`, {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + token,
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) throw new Error('Erreur chargement infos demande');
                const data = await response.json();
                const demande = data.result || data.results || data; // selon format API
                // Remplir l'en-t√™te
                //alert(JSON.stringify(demande));
                document.getElementById('requestNumber').textContent = "###DEM-" + demande.categorie_demande + "-" + demande.id_demande;
                document.getElementById('banque').textContent = demande.banque_user;
                document.getElementById('clientName').textContent = demande.nom_client;
                document.getElementById('requestType').textContent =  demande.type_demande;
                document.getElementById('requestAmount').textContent = demande.montant + ' XOF';
                document.getElementById('requestStatus').textContent = demande.description;
                document.getElementById('requestDate').textContent = demande.date_creation;
             
            } catch (e) {
                showNotification(e.message, 'error');
            }
        }
        window.addEventListener('load', () => remplirEnteteDemande());


    </script>

</html>
